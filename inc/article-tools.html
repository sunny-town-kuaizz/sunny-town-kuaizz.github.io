<?php
/**
 * 文章特殊内容（短代码）支持 
 */
if(!defined('THEME_NAME')) die('非法访问 - Insufficient Permissions');

// 增强编辑器，添加自定义代码
function mk_editor_tools() {
    // 火狐特殊对待……
    $is_firefox = isset($_SERVER['HTTP_USER_AGENT'])? stripos($_SERVER['HTTP_USER_AGENT'], 'firefox'): false;
?>
    <script>
    var mk_theme_api = {};
    </script>
    
    <script type="text/javascript" src="<?php echo get_bloginfo('template_directory'); ?>/static/js/script.min.js"></script>
    
    <style>
    .emoji_btn{position:absolute;display:inline-block;cursor:pointer;width:25px;height:25px}.emoji_container *{-webkit-box-sizing:border-box;-moz-box-sizing:border-box;box-sizing:border-box}.emoji_container{z-index: 99999999999999999999;display:none;max-width:544px;position:absolute;background-color:#fff;border:1px solid #bfbfbf;box-shadow:0 1px 3px rgba(0,0,0,0.176)}.emoji_container ul{list-style:none;padding-left:0;margin:0}.emoji_content{height:277px;overflow-y:auto;padding:5px}.emoji_content ul{padding-top:1px;padding-left:1px}.emoji_content ul li{width:54px;height:54px;float:left;border:1px solid #e3e3e3;margin-top:-1px;margin-left:-1px;margin-right:0;margin-bottom:0}.emoji_content ul li a{display:block;line-height:54px;text-align:center;cursor:pointer}.emoji_content ul li a img{vertical-align:middle;max-width:52px;max-height:52px}.emoji_content .mCSB_scrollTools{width:10px}.emoji_content .mCSB_outside+.mCS-minimal-dark.mCSB_scrollTools_vertical,.emoji_content .mCSB_outside+.mCS-minimal.mCSB_scrollTools_vertical{margin:5px 0}.emoji_tab{background-color:#f7f7f7;border-top:1px solid #e3e3e3;color:#666;height:32px;position:relative}.emoji_tab_prev{border-top:4px solid transparent;border-bottom:4px solid transparent;border-right:4px dashed;cursor:pointer;left:8px;top:12px;position:absolute;display:inline-block;height:0;vertical-align:middle;width:0}.emoji_tab_next{border-top:4px solid transparent;border-bottom:4px solid transparent;border-left:4px dashed;cursor:pointer;right:7px;top:12px;position:absolute;display:inline-block;height:0;vertical-align:middle;width:0}.emoji_tab_list{left:22px;overflow:hidden;position:absolute;top:0;width:500px}.emoji_tab_list ul{width:1500px;transition:all .8s ease 0s}.emoji_tab_list ul li{border-top:0 none;cursor:pointer;float:left;height:22px;line-height:22px;margin:5px 4px 0 0;font-size:12px;border-radius:3px;text-align:center;width:68px;overflow:hidden;white-space:nowrap;text-overflow:ellipsis}.emoji_tab_list ul li:hover{background:#e5e5e5}.emoji_tab_list ul li.selected{color:#fff;background:steelblue}.emoji_preview{position:absolute;top:0;border:1px solid #c8c8c8;border-radius:50%;width:65px;height:65px;background:#fff;text-align:center;line-height:65px;box-shadow:1px 1px 3px rgba(0,0,0,0.176);z-index:2;display:none}.emoji_preview img{vertical-align:middle;max-width:42px;max-height:42px}.emoji_tab_next,.emoji_tab_prev{display:none}.emoji_tab_list{left:8px}.emoji_tab_list ul li{width:auto;padding:0 15px;-khtml-user-select:none;-moz-user-select:none;user-select:none;-webkit-transition:.2s;-moz-transition:.2s;-o-transition:.2s;-ms-transition:.2s;transition:.2s}.emoji_content ul li{display:inline-block;float:none}.emoji_content ul li a img{max-height:35px}.emoji_container{margin-right:10px;max-width:520px}.emoji_preview{pointer-events:none}
    .mk-pop-box {
        z-index: 999999999999;
        width: 90%;
        max-width: 500px;
        height: 440px;
        position: fixed; margin: auto; left: 0; right: 0; top: 0; bottom: 0;
        background-color: #fff;
        box-shadow: 0 0 20px #969696;
        border-radius: 2px;
        padding: 10px;
        box-sizing: border-box;
    }
    .mk-pop-box-title {
        font-size: 20px;
        margin: 5px 0 10px 5px;
        font-weight: 100;
    }
    .mk-pop-box table {
        width: 100%;
    }
    </style>
    <button type="button" id="mk-insert-emoji-button" class="button" data-editor="content">
        <span class="dashicons dashicons-smiley"></span> 
        添加表情
    </button>
    <input id="tmp-emoji-input" types="text" style="width: 0;height: 0;position: absolute;left: -999999px;">
    
    <select id="mk-short-code-select"<?php if(!$is_firefox) echo ' class="button"'; ?>>
        <option value=''>添加短代码</option>
        <option value='<h2>文章小标题</h2>'>文章小标题</option>
        <option value='[collapse title="点击查看完整内容"]被隐藏的内容[/collapse]'>折叠展开</option>
        <option value='<fieldset><legend>温馨提示</legend>提示内容</fieldset>'>温馨提示</option>
        <option value='[netmusic id="网易云音乐ID" autoplay="false"]'>网易云音乐</option>
        <option value='[reply]评论可见的内容[/reply]'>评论可见</option>
        <!--<option value='[secret key="123456"]输入密码可见内容[/secret]'>密码可见</option>-->
        <option value='<span style="color: #ff6600;">重点高亮内容</span>'>高亮文字</option>
        <option value='[button url="链接地址" types="down"]按钮文字[/button]'>下载按钮</option>
        <option value='[button url="链接地址" types="link"]按钮文字[/button]'>链接按钮</option>
        <option value='[button url="链接地址"]按钮文字[/button]'>普通按钮</option>
        <option value='[video]视频引用地址[/video]'>视频</option>
        <option value='[post id="文章ID"]'>文章引用</option>
        <option value='[alert class="success"]这里输入内容[/alert]'>绿色的警告条</option>
        <option value='[alert class="info"]这里输入内容[/alert]'>灰色的警告条</option>
        <option value='[alert class="warning"]这里输入内容[/alert]'>橙色的警告条</option>
        <option value='[alert class="danger"]这里输入内容[/alert]'>红色的警告条</option>
        <option value='[tabs]
    [tab title="标签页1"]内容 1[/tab]
    [tab title="标签页2" active]可以用 active 参数指定默认展示的 tab 页是哪一个[/tab]
    [tab title="标签页3"]内容 3[/tab]
[/tabs]'>标签页</option>
        <option value='<ol class="mk-timeline">
    <li>
        <b>2020/02/02</b>内容内容内容内容
    </li>
    <li>
        <b>2020/02/06</b>内容内容内容内容内容内容
    </li>
    <li>
        <b>2020/02/22</b>注意：时间轴中的内容与前面的时间节点之间不能有换行，否则不好看……
    </li>
</ol>'>时间线</option>
        <option value='[ad]'>文章内嵌广告</option>
    </select>
    <?php if(mk_theme_option('code_highlight')) : ?>
    <button type="button" id="mk-insert-code-button" class="button">
        <span class="dashicons dashicons-editor-code" style="margin-top: 3px;"></span> 
        添加代码
    </button>
    <?php endif; ?>
    <script type="text/javascript">
    jQuery(document).ready(function($) {
        var emoji_btn = $("#mk-insert-emoji-button");
        $("#mk-insert-emoji-button").click(function() {
            if(!$(this).data("loaded")) {
                $("#tmp-emoji-input").emoji({
                    button: emoji_btn,
                    animation: "fade",
                    basePath: "<?php echo get_bloginfo('template_directory'); ?>/static/images/emoji",
                    icons: emojiLists
                });
                $(this).data("loaded", true);
                /* $(this).click(); */
            }
        });
        $(window).scroll(function() {
            $(".emoji_container").css({"top": emoji_btn.offset().top + emoji_btn.outerHeight() + 10 + "px"});
        });
        $("#tmp-emoji-input").focus(function() {
            wp.media.editor.insert($(this).val());
            $(this).val(""); 
        });
        $("#mk-short-code-select").change(function() {
            if($(this).val()) {
                wp.media.editor.insert($(this).val());
                $(this).val("")
            }
            return false;
        });
        $("#mk-insert-code-button").click(function(){
            mkInsertCode = $('<div class="mk-pop-box"></div>').appendTo('body');
            mkInsertCode.html($("#mk-insert-code").html());
            $("#mk-code-submit").click(function() {
                var html = '<pre class="prettyprint lang-' + $("#mk-code-lang").val() + ' linenums:' + $("#mk-code-lines").val() + '">';
                html += mkEscapeHtml($("#mk-code-value").val());
                html += '</pre>';
                wp.media.editor.insert(html);
                mkInsertCode.remove();
            });
        });
    });
    function mkEscapeHtml(text) {
        return text.replace(/&/g, "&amp;").replace(/"/g, "&quot;").replace(/'/g, "'").replace(/</g, "&lt;").replace(/>/g, "&gt;");
    }
    </script>
    <script type="text" id="mk-insert-code">  
    <h1 class="mk-pop-box-title">添加代码</h1>
    <button type="button" class="media-modal-close" onclick="mkInsertCode.remove()"><span class="media-modal-icon"></span></button>
    <table>
    <tr>
    <td width="25%">代码语言</td>
    <td width="25%">
    <select id="mk-code-lang">
        <option value="html">HTML</option>
        <option value="php">PHP</option>
        <option value="js">JavaScript</option>
        <option value="java">Java</option>
        <option value="css">CSS</option>
        <option value="pl">Perl</option>
        <option value="py">Python</option>
        <option value="rb">Ruby</option>
        <option value="vb">ASP/VB</option>
        <option value="cpp">C/C++</option>
        <option value="cs">C#</option>
        <option value="xml">XML</option>
        <option value="bsh">Shell</option>
        <option value="">Other</option>
    </select>
    </td>
    <td width="25%">起始行号</td>
    <td width="25%"><input id="mk-code-lines" type="number" value="1"></td>
    </tr>
    <tr>
    <td colspan="4">
    <textarea id="mk-code-value" style="width:100%;height:300px;margin-top: 10px"></textarea>
    </td>
    </tr>
    </table>
    <input id="mk-code-submit" class="button button-primary button-large" type="button" value="插入" style="float: right">
    </script>
<?php
}
if (current_user_can('edit_posts') || current_user_can('edit_pages')) {
    add_action('media_buttons', 'mk_editor_tools', 0);
}


// 对按钮的处理
function mk_button($atts, $content = null) {
    extract(shortcode_atts(array('url' => '##', 'types' => ''), $atts));
    $types = trim(strtolower($types));
    switch($types) {
        case '':         // 普通无图标按钮
            $tmp = '';
        break;
        
        case 'down':    // 下载按钮
            $tmp = '<i class="fa fa-download"></i> ';
        break;
        
        case 'link':    // 链接按钮
            $tmp = '<i class="fa fa-rocket"></i> ';
        break;
        
        default:        // fontawsome按钮
            $tmp = '<i class="fa fa-' . htmlspecialchars($types) . '"></i> ';
    }
    return '<a href="'.$url.'" class="btn" target="_blank" rel="external nofollow">' . $tmp . htmlspecialchars($content). '</a>';
}
add_shortcode('button', 'mk_button');


// 下载按钮（兼容之前用的 Nana 主题。。）
function mk_nana_btn($atts, $content = null) {
    $id = get_the_ID();
	$html = '';
    for($i = 1; $i <= 4; $i ++) {
        if(get_post_meta($id, 'url'.$i, true)) {
            $html .= '<a href="'.get_post_meta($id, 'url'.$i, true).'" class="btn" target="_blank" rel="external nofollow">
              <i class="fa fa-download"></i> ' .get_post_meta($id, 'button'.$i, true). '</a>';
        }
    }
	return $html;
}
add_shortcode('file', 'mk_nana_btn');


// 文章部分内容评论可见
function mk_reply_read($atts, $content = null) {
    extract(
        shortcode_atts(
            array('notice' => '
            <fieldset>
                <legend>此部分已被隐藏</legend>
                <p style="margin: 5px 0">
                <i class="fa fa-commenting" aria-hidden="true"></i><a href="#respond">发表评论</a>并
                <a href="" onclick="location.reload();return 0;" data-no-instant>刷新</a>页面后方可查看</p>
            </fieldset>
            '), $atts)
        );
    
    $user_ID = (int) wp_get_current_user()->ID;
    if ($user_ID) {
        if ( current_user_can('level_10') ) {
            return '<fieldset><legend>本文隐藏的内容</legend>'.do_shortcode( $content ).'</fieldset>';
        }
        // 获取登录用户邮箱
        $email = get_userdata($user_ID)->user_email;
    } else if (isset($_COOKIE['comment_author_email_' . COOKIEHASH])) {
        $email = trim(str_replace('%40', '@', $_COOKIE['comment_author_email_' . COOKIEHASH]));
        
        // 空邮箱
        if (empty($email)) return $notice;
        
        // 不合规的邮箱
        if(!is_email($email)) return $notice.'<p style="color: red">Ooops! 您输入的邮箱似乎有点问题...</p>';
    } else {
        return $notice;
    }
    
    // 判断用户是否已评论
    global $wpdb;
    $post_id = get_the_ID();
    $query = "
        SELECT `comment_ID` 
        FROM {$wpdb->comments} 
        WHERE `comment_post_ID`={$post_id} AND `comment_author_email`='{$email}' 
        LIMIT 1";
    
    if ($wpdb->get_results($query)) {
        return '<fieldset><legend>本文隐藏的内容</legend>'.do_shortcode( $content ).'</fieldset>';
    } else {
        return $notice;
    }
}
add_shortcode('reply', 'mk_reply_read');  

// 文章部分内容密码可见
// function mk_password_read($atts, $content=null){
//     extract(shortcode_atts(array('key'=>null), $atts));
//     if(isset($_POST['secret_key']) && $_POST['secret_key'] == $key) {
//         return '<div class="secret-password"><h2>加密的内容：</h2><p>'.do_shortcode( $content ).'</p></div>';
//     } else {
//         return '
//         <form class="post-password-form" action="'.get_permalink().'" method="post">
//             <p>
//                 <div class="post-secret"><i class="fa fa-exclamation-circle"></i>输入密码查看加密内容：</div>
//             </p>
//             <p>
//                 <input id="pwbox" type="password" size="20" name="secret_key">
//                 <a class="a2" href="javascript:;"><input type="submit" value="提交" name="Submit"></a>
//             </p>
//         </form>	';
//     }
// }
// add_shortcode('secret','mk_password_read');


// 展开收缩功能
function mk_collapse($atts, $content = null) {
    extract(shortcode_atts(array('title' => '点击查看完整内容'), $atts));
    return '<section class="mk-collapse">
        <div class="mk-collapse-title anim-trans" title="点击查看被隐藏的内容">
            <i class="fa fa-chevron-down anim-trans" aria-hidden="true"></i> '.$title.'
        </div>
        <div class="mk-collapse-content clear-fix" hidden><p>
        ' . do_shortcode(mk_remove_extra_line($content)) . '
        </div>
    </section>';
}
add_shortcode('collapse', 'mk_collapse');


// 网易云音乐（因为网易云糟糕的版权问题，该短代码已半死不活……）
function mk_163_music($atts) {
    extract(shortcode_atts( array('id' => '31460355', 'autoplay' => true ) , $atts));
    return '<iframe style="width:100%;max-height:86px;margin: 20px -10px;" frameborder="no" border="0" 
     marginwidth="0" marginheight="0" src="https://music.163.com/outchain/player?type=2&id=' . $id . 
     '&auto=' . ($autoplay == "false"? 0: 1) . '&height=66"></iframe>';
}
add_shortcode('netmusic', 'mk_163_music');


// 视频
function mk_video($atts, $content = null) {
    return '<div class="mk-video-box"><div>
    <iframe src="' . do_shortcode($content) . '" scrolling="no" border="0" frameborder="no" framespacing="0" allowfullscreen="true"></iframe>
    </div></div>';
}
add_shortcode('video', 'mk_video');

// 移除 wp 默认的视频转换
wp_embed_unregister_handler('youku');

// 优酷
function mk_embed_handler_youku( $matches, $attr, $url, $rawattr ) {
    $html = '<div class="mk-video-box"><div>
    <iframe src="https://player.youku.com/embed/'.$matches['video_id'].'" scrolling="no" border="0" frameborder="no" framespacing="0" allowfullscreen="true"></iframe>
    </div></div>';
    return $html;
}
wp_embed_register_handler( 'mk_youku',
	'#https?://v\.youku\.com/v_show/id_(?<video_id>[a-z0-9_=\-]+)#i',
	'mk_embed_handler_youku' );

// bilibili
function mk_embed_handler_bilibili( $matches, $attr, $url, $rawattr ) {
    $html = '<div class="mk-video-box"><div>
    <iframe src="https://player.bilibili.com/player.html?aid='.$matches['vid'].'&page='.$matches['page'].'" scrolling="no" border="0" frameborder="no" framespacing="0" allowfullscreen="true"></iframe>
    </div></div>';
    return $html;
}
wp_embed_register_handler( 'mk_bilibili',
	'#https?://www\.bilibili\.com/video/av(?<vid>[a-z0-9_=\-]+)/?\?p=(?<page>\d+)#i',
	'mk_embed_handler_bilibili' );


// 引用文章 （样式来自知乎）
function mk_embed_post( $atts, $content = null ) {
    extract(shortcode_atts( array('id' => ''), $atts ));
    global $post;
    $content = '';
    $postids = explode(',', $id);
    $inset_posts = get_posts(array(
            'post__in'    => $postids, 
            'post_type'   => 'any', 
            'orderby'     => 'none', 
            'numberposts' => -1
        ));
    
    foreach ($inset_posts as $key => $post) {
        setup_postdata( $post );
        $img          = mk_auto_post_thumbnail(360, 240, true);
        $title        = get_the_title();
        $commentCount = ( !post_password_required() && comments_open() ) ? get_comments_number(): '-';
        $content .= '<section class="mk-embed-card">
        <a href="'.get_the_permalink().'" title="'.$title.'">
            <span class="mk-embed-background" style="background-image: url('.$img.');"></span>
            <span class="mk-embed-content">
                <span>
                    <h4 class="mk-embed-title">'.$title.'</h4>
                    <span class="mk-embed-meta">
                        <i class="fa fa-calendar" aria-hidden="true"></i>
                        '.timeago(get_gmt_from_date(get_the_time('Y-m-d G:i:s'))).'
                        
                        <i class="fa fa-comments" aria-hidden="true"></i>
                        ' . $commentCount . '
                    </span>
                </span>
                <img class="mk-embed-image no-shadow" alt="'.$title.'" src="'.$img.'">
            </span>
        </a></section>';
    }
    wp_reset_postdata();
    return $content;
}
add_shortcode('post', 'mk_embed_post');


// 添加友链短代码
function mk_linklist($atts, $content = null) {
    extract(shortcode_atts(array( 
        'catid'   => '',
        'orderby' => 'link_id',
        'desc'    => false
    ) , $atts));
    
    $bookmarks = get_bookmarks(array(
        'category' => $catid,
        'orderby'  => $orderby,
        'order'    => $desc? 'DESC': 'ASC'
    ));
    
    if(empty($bookmarks)) {
        return '';
    }
    
    $html = '<ul class="links-list clear-fix">';
    $default_ico = MK_THEME_STATIC_URL . '/images/default_favicon.ico';
    foreach($bookmarks as $bookmark) {
        // var_dump($bookmark);
        $link_ico = $bookmark->link_image;
        if(!$link_ico) {
            $favicon_api = mk_theme_option('favicon_api');
            if($favicon_api) {
                // 只能获取 favicon
                $link_url = $bookmark->link_url;
                $link_url = str_replace(array('http://', 'https://', '//'), '', $link_url);
                $link_ico = $favicon_api.$link_url;
            } else {
                $link_ico = $bookmark->link_url.'/favicon.ico';
            }
        }
        $html .= '
        <li>
            <img class="no-error" src="'.$link_ico.'" onerror="onerror=null;src=\''.$default_ico.'\'"><a class="links" 
              href="'.$bookmark->link_url.'" title="'.$bookmark->link_notes.'" target="_blank" no-jump-page>'.$bookmark->link_name.'</a>
        </li>';
    }
    $html .= '</ul>';
    return $html;
}
add_shortcode('linklist', 'mk_linklist');


// 警告框 （样式来自 element）
function mk_alert( $atts, $content = null ) {
    extract(shortcode_atts( array('class' => '' ) , $atts));
    return '<div class="mk-alert '.$class.'">'.$content.'</div>';
}
add_shortcode('alert', 'mk_alert');


// 标签 https://stackoverflow.com/questions/16414272/custom-shortcode-for-creating-tabs
add_shortcode('tab', 'mk_tabs');
function mk_tabs($atts, $content) {
    $is_active = in_array('active', $atts) || array_key_exists('active', $atts);
    if($is_active) {
        if($GLOBALS['mk_tabs']['have_active']) {
            $is_active = false;     // 防止多个 tab 被激活
        } else {
            $GLOBALS['mk_tabs']['have_active'] = true;
        }
    }
    
    extract(shortcode_atts(array(
        'title'  => 'Tab'
    ), $atts));

    $GLOBALS['mk_tabs']['tabs'][] = array( 
        'title'   => $title,
        'class'   => $is_active? 'selected': '',
        'content' => mk_remove_extra_line($content),
    );
}

add_shortcode('tabs', 'mk_tabgroup');
function mk_tabgroup($atts, $content) {
    $GLOBALS['mk_tabs'] = array(
        'have_active' => false,
        'tabs'        => array()
    );
    
    do_shortcode($content);   // 这行的作用是取出标签内容，放入全局
    
    if(count($GLOBALS['mk_tabs']['tabs'])) {
        $tabs_head = array();
        $tabs_body = array();
        $tab_index = 0;
        
        // 如果没有标签被选定，则默认选定首个
        if(!$GLOBALS['mk_tabs']['have_active']) {
            $GLOBALS['mk_tabs']['tabs'][0]['class'] .= ' selected';
        }
        
        foreach($GLOBALS['mk_tabs']['tabs'] as $tab) {
            $tab_index++;
            $tab_class  = !empty($tab["class"])? ' ' . $tab["class"]: '';
            $tabs_head[] = 
                '<div class="mk-tab-title' . $tab_class . '" role="tab" data-tab-index="' . $tab_index . '">' 
                    . $tab['title'] . 
                '</div>';
            $tabs_body[] = 
                '<div class="mk-tab-content' . $tab_class . '" data-tab-index="' . $tab_index . '">' 
                    . $tab['content'] . 
                '</div>';
            //echo '<pre>' . $tab['content'] . '</pre>';
        }
        
        $return = '
            <div class="mk-tabs">
                <div class="mk-tabs-head">
                    ' . implode('', $tabs_head) . '
                </div>
                <div class="mk-tabs-body">
                    ' . implode('', $tabs_body) . '
                </div>
            </div>';       
    }
    return do_shortcode($return);
}


// 文章内嵌广告
add_shortcode('ad', 'mk_article_embed_ad');
function mk_article_embed_ad($atts, $content) {
    return mk_theme_option('article_embed_ad');
}


/*****************************************************************/

// 添加文章设置编辑框
add_action( 'admin_menu', 'mk_add_article_set_box' );
function mk_add_article_set_box() {
    $screens = array( 'post', 'page' );
    foreach ($screens as $screen) {
        add_meta_box(
            'mk_article_set_box',      // #id
            '文章设置',
            'mk_article_set_box_html', // html 代码函数
            $screen,                   // 显示的文章类型(post、page，link)
            'side',                    // 显示位置(normal、advanced、side）
            'core'                     // 显示的优先级别(high、core、default、low）
        );
    }
}

// 文章设置编辑框 html 回调
function mk_article_set_box_html() {
	global $post;
	
	$article_from = get_post_meta( $post->ID, 'article_from', true );
?>
    <p class="mk_article_set_title">文章类型</p>
    
    <label style="margin-right: 8px">
        <input type="radio" class="mk_article_from" name="article_from" value="" 
          <?php if(!$article_from) echo 'checked="checked"'; ?>/>
        原创文章
    </label>
    
    <label>
        <input type="radio" class="mk_article_from" name="article_from" value="reprint" 
          <?php if($article_from == 'reprint') echo 'checked="checked"'; ?>/>
        转载文章
    </label>
    
    <div id="mk_article_set_more">
        <p class="mk_article_set_title">原文作者</p>
        
        <input type="text" name="article_auth" 
          value="<?php echo get_post_meta( $post->ID, 'article_auth', true ); ?>">
        
        <p class="mk_article_set_title">原文链接</p>
        
        <input type="text" name="article_url"
          value="<?php echo get_post_meta( $post->ID, 'article_url', true ); ?>">
    </div>

    <input type="hidden" name="mk_article_set_input_name" 
        id="mk_article_set_input_name" value="<?php echo wp_create_nonce( plugin_basename( __FILE__ ) ); ?>" />

	<script>
    jQuery(function ($) {
        mkCheckArticleStatus();
        
        $(".mk_article_from").click(function () {
            mkCheckArticleStatus();
        });
        
        function mkCheckArticleStatus() {
            if($('.mk_article_from:radio:checked').val()) {
                $("#mk_article_set_more").slideDown();
            } else {
                $("#mk_article_set_more").slideUp();
            }
        }
    });
    </script>
    <style>
    .mk_article_set_title {
        margin: 1em 0 .6em;
    }
    #mk_article_set_box input[name="article_auth"], #mk_article_set_box input[name="article_url"] {
        width: 100%;
    }
    #mk_article_set_more {
        display: none;
    }
    </style>
<?php
}

// 保存文章设置信息数据
add_action( 'save_post', 'mk_save_article_set_data' );
function mk_save_article_set_data( $post_id ) {
    // 失效检测
    if ( !isset($_POST['mk_article_set_input_name']) || (!wp_verify_nonce( $_POST['mk_article_set_input_name'], plugin_basename( __FILE__ ) )) )
        return $post_id;
    
    // 权限检测
    if ( 'page' == $_POST['post_type'] && !current_user_can( 'edit_page', $post_id ) )
        return $post_id;
    elseif ( 'post' == $_POST['post_type'] && !current_user_can( 'edit_post', $post_id ) )
        return $post_id;
    
    // 获取数据并保存
    mk_set_post_meta($post_id, 'article_from', $_POST['article_from']);      // 文章来源
    
    if($_POST['article_from']) {
        mk_set_post_meta($post_id, 'article_auth', $_POST['article_auth']);  // 文章作者
        mk_set_post_meta($post_id, 'article_url', $_POST['article_url']);    // 文章链接
    } else {
        mk_set_post_meta($post_id, 'article_auth', '');    // 文章作者
        mk_set_post_meta($post_id, 'article_url', '');     // 文章链接
    }
}

// 保存一个文章额外数据
function mk_set_post_meta($post_id, $name, $value = '') {
    $value = stripslashes($value);    // 去除反斜杠
    if ( get_post_meta( $post_id, $name ) == '' )    // 没有值
        add_post_meta( $post_id, $name, $value, true );    // 添加
    elseif ( $value != get_post_meta( $post_id, $name, true ) )    // 有值但不一样
        update_post_meta( $post_id, $name, $value );    // 修改
    elseif ( $value == '' )    // 值为空
        delete_post_meta( $post_id, $name, get_post_meta( $post_id, $name, true ) );    // 删除
}